# QSettings: Saving and managing app sessions and other settings
## Pyside 2/6 | PyQt 5/6
### _QSettings is an abstraction around these technologies, enabling you to save and restore application settings in a portable manner. It also supports custom storage formats._
### _QSettings's API is based on QVariant, allowing you to save most value-based types, such as QString, QRect, and QImage, with the minimum of effort._

[![ READ MORE | QT](https://d33sqmjvzgs8hq.cloudfront.net/wp-content/themes/oneqt/assets/images/favicon-32x32.png)](https://doc.qt.io/qt-6/qsettings.html)

This simple guide will show you how to use QSwttings class in your app. We will build an app that uses QSettings to:

- Save current app theme (Light/Dark) in settings.
- Save app ID and Key
- Use app ID and key to authenticate app users

App Dark Theme
![Screenshot_20220716_093347.png](https://www.dropbox.com/s/8ha901b79ruhjwq/Screenshot_20220716_093347.png?dl=0&raw=1)
App Light Theme
![Screenshot_20220716_093443.png](https://www.dropbox.com/s/22ks00mgzaq2qnf/Screenshot_20220716_093443.png?dl=0&raw=1)

## Getting started
### Installation
Download and install Puthon. Then install the required modules:
- PyQt
- PySide
- and the Custom Widgets module

You can simply install all the above modules by just running:
```cmd
pip install QT-PyQt-PySide-Custom-Widgets
```
Pyside, PyQt and other dependencies will automatically be installed.
You also need the ``QT Designer app``. You can find this app inside the PySide module in python's ``site-packages`` folder or you can download the app from QT's website. Other OS distributors such as ``Linux Manjaro`` comes with QT applications such as QT Designer installed.

### Creating and setting up the project
The Custom Widgets module comes with a ``Project Maker / Setup Wizard `` that will help you create your project. 
Click here -- [documentation](https://khamisikibet.github.io/QT-PyQt-PySide-Custom-Widgets/docs/project-maker.html) or [video](https://youtu.be/8Rez2mm2PZ0) to create the project.

After creating your project, open the ``interface.ui`` file inside your project and design your interface. This guide will not cover UI designing, we will only focus on  QSettings class.
Incase you want my ``interface.ui`` file used in this app, you can download it from [here](https://www.patreon.com/posts/69180320).

![Screenshot_20220630_031607.png](https://www.dropbox.com/s/688z81sm7vsh9m5/Screenshot_20220630_031607.png?dl=0&raw=1)

### Creating the APP THEME
The custom widgets module comes with a Theme Engine for Qt (Python) desktop apps. This theme engine helps you apply beautiful modern and uniform style across your by just writing simple lines of code. 
Read more about the Custom Widgets' Theme Engine here: [documentation](https://khamisikibet.github.io/QT-PyQt-PySide-Custom-Widgets/docs/qt-theme-engine.html) or [video tutorial](https://youtu.be/QkA5pefr9Mo).

Our app in this guide will only have two themes "Light and Dark themes". 
> The custom widgets module comes with the default dark and light themes.
We will make our own custom themes here. 
> To learn how to use the default themes click here: [documentation](https://khamisikibet.github.io/QT-PyQt-PySide-Custom-Widgets/docs/qt-theme-engine.html) or [video tutorial](https://youtu.be/QkA5pefr9Mo).

To create the two themes, locate the ``style.json`` file inside your project folder. Open this file.

![Screenshot_20220718_014254.png](https://www.dropbox.com/s/hdi731w5swog1t0/Screenshot_20220718_014254.png?dl=0&raw=1)

Inside your ``QSettings`` object add the following lines of code:

> NOTE: Do not change your app, organisation or dormain name. They should be autogenerated by the project setup wizard. 
> Only add the custom theme part.

```json
"QSettings": [
        {
            "ThemeSettings": [
                {
                    "CustomTheme": [
                        {
                            "Background-color": "#fff",
                            "Text-color": "#000",
                            "Accent-color": "#40a6e2",
                            "Theme-name": "Default-Light",
                            "Icons-color": "#8393a3",
                            "Default-Theme": true
                        },
                        {
                            "Background-color": "#283a4d",
                            "Text-color": "#fff",
                            "Accent-color": "#40a6e2",
                            "Theme-name": "Default-Dark",
                            "Icons-color": "#8393a3",
                            "Default-Theme": false
                        }
                    ]
                }
            ],
            "AppSettings": {
                "OrginizationName": "QT Settings Session",
                "ApplicationName": "QT Settings Session Company",
                "OrginizationDormain": "QT Settings Session.org"
            }
        }
    ],
```

> HINT: Its important that the ``"Icons-color"`` for both themes match to avoid the need to restrat your app once you change the theme inorder for the new icons to  be applied. 

### Applying the app theme.

- Open the ``main.py`` file
- Then add the following statement just below the "show window" statement:

```python
        #######################################################################
        # SHOW WINDOW
        #######################################################################
        self.show() 

        ########################################################################
        # UPDATE APP SETTINGS LOADED FROM JSON STYLESHEET 
        # ITS IMPORTANT TO RUN THIS AFTER SHOWING THE WINDOW
        # THIS PROCESS WILL RUN ON A SEPARATE THREAD WHEN GENERATING NEW ICONS
        # TO PREVENT THE WINDOW FROM BEING UNRESPONSIVE
        ########################################################################
        # self = QMainWindow class
        QAppSettings.updateAppSettings(self)
```

> Note that we created two themes named, ``Default-Light`` and ``Default-Dark`` inside the ``style.json`` file.

- To apply one of the the themes, add the following statement below the above statement you just added:

```python
        # CHANGE THE THEME NAME IN SETTINGS
        # Use one of the app themes from your JSON file
        settings = QSettings()
        settings.setValue("THEME", "Default-Light")
        QAppSettings.updateAppSettings(self)
```

> The above statement will apply the Light theme each time we restart the app. 
> Since we want our app theme to dymamic, we will create a function for that.
> Comment out/remove the above the above statements.

- To create a dynamic app theme, I will add a ``checkbox`` in my ``interface file``. When this checkbox is ``checked`` the app should apply the dark theme and when ``unchecked`` a light theme should be applied. 
- Now add the check box ``state event`` listener inside the ``main.py``

```python
        # CHECKBOX EVENT LISTENER
        self.ui.checkBox.stateChanged.connect(lambda: self.changeAppTheme())
```

> ``"self.changeAppTheme()"`` is a function we will create later. When the checbox state is changed, this function will run.

- We also need to update the checkbox status on app startup to reflect the current app theme. Add the following lines belo the above statement.

```python
        # UPDATE THE CHECKBOX STATUS
        settings = QSettings()
        currentTheme = settings.value("THEME")
        if currentTheme == "Default-Dark":
            # Check the checkbox
            self.ui.checkBox.setChecked(True)
        else:
            # Unheck the checkbox
            self.ui.checkBox.setChecked(False)

```

- Now let us add the ``"self.changeAppTheme()"`` function. This function will apply the "Dark" or "Light" theme when  the ckeckbox status is changed. The following lines just above the "if main" statement.

```python
    # Change App Theme function
    def changeAppTheme(self):
        settings = QSettings()
        if self.ui.checkBox.isChecked():
            settings.setValue("THEME", "Default-Dark")
        else:
            settings.setValue("THEME", "Default-Light")

        QAppSettings.updateAppSettings(self)
    # END 

########################################################################
## EXECUTE APP
########################################################################
if __name__ == "__main__":
    app = QApplication(sys.argv)
    ########################################################################
    ## 
    ########################################################################
    window = MainWindow()
    window.show()
    sys.exit(app.exec_())
########################################################################
## END===>
########################################################################  

````

Now the ``QSettings`` class will remember your ``App Theme Settings`` even after you close your app!

## User Authentication and Session Keys
There are multiple ways you can store and retrieve app sessions in python.
> A session is the amount of time in which a user is actively engaged with either an app in the foreground or with an open website. 

In this guide, we will create an app session once the user ``registers`` or ``logs`` in successfully. 
We will give our ``session a lifespan`` of ``24 hours`` after which the user will be requested to log in again. 

- Add two forms to the interface:

Login form
![Screenshot_20220719_025525.png](https://www.dropbox.com/s/3sea680y2czoa2j/Screenshot_20220719_025525.png?dl=0&raw=1)

Register form
![Screenshot_20220719_025534.png](https://www.dropbox.com/s/3e9663cgmgnf3ux/Screenshot_20220719_025534.png?dl=0&raw=1)

- Create the functions file ``Functions.py`` inside your project folder. This file will contain app functions to validate, login and create user sessions.

#### Functions.py file
- Import the required modules inside the "Functions.py" file:

```python
from PySide2.QtWidgets import QLineEdit, QMessageBox
from PySide2.QtGui import QIcon
from PySide2.QtCore import QSize

import requests
import urllib
from urllib.parse import urlencode
import json

########################################################################
# IMPORT Custom widgets
from Custom_Widgets.Widgets import *
# INITIALIZE APP SETTINGS
settings = QSettings()
########################################################################

```

- Create the ``AppFunctions class`` inside the Functions.py file:

```python
########################################################################
# APP FUNCTIONS
# REGISTER/LOGIN USERS
# GENERATE UNIQUE APP ID/KEY
# SAVE APP SESSION(KEY/ID)
########################################################################
class AppFunctions():
    """docstring for AppFunctions"""
    def __init__(self, arg):
        super(AppFunctions, self).__init__()
        self.arg = arg
```

- Before continuing, ``import the AppFunctions`` to the ``main.py`` file:

```python
# import AppFunctions to main.py
from Functions import AppFunctions
```
- Create a function inside AppFunctions class in Functions.py file to validate the login form:

```python
    #######################################################################
    # LOGIN FUNCTION
    #######################################################################
    #Validate user input and display messages
    def login(self):
        # Validate form field
        if len(self.ui.loginUsername.text()) > 3:
            if len(self.ui.loginPassword.text()) < 10:
                self.ui.loginResponse.setText("Please enter a valid password")
                self.ui.loginResponse.setStyleSheet("color: red;")
            else:
                self.ui.loginResponse.setText("Please wait...")
                self.ui.loginResponse.setStyleSheet("color: '';")

                # Submit login data
                AppFunctions.loginUser(self)
        
        else:
            self.ui.loginResponse.setText("Please enter a valid username")
            self.ui.loginResponse.setStyleSheet("color: red;")
```

- If the user input is valid, submit the login form. This is the submit function:

```python
    #######################################################################
    # SUBMIT LOGIN DETAILS
    #######################################################################
    def loginUser(self):
        username = self.ui.loginUsername.text()
        password = self.ui.loginPassword.text()
        # CATCH NETWORK ERROR USING TRY CATCH METHOD
        try:
            # Web url
            # url = "http://localhost/appsettings/"
            url = "http://project.spinntv.com/python/qtsettings/"
            # Get current app id and key from settings(if available)
            id, key = AppFunctions.getAppIdKey(self)
            data = {"login": True, "username":username,"password":password, "app_id": id, "app_key": key}
            responseData = json.loads(requests.post(url, data=data).content.decode('utf-8'))
            print(responseData)
            self.ui.loginResponse.setText(responseData['response_message'])
            # If logged in continue to final page
            if responseData['logged_in']:
                # Save the returned app key and id
                AppFunctions.createNewAppKey(self, responseData['app_id'], responseData['app_key'])
                # then validate the saved app key and id
                AppFunctions.checkAppKey(self)

            else:
                self.ui.loginResponse.setStyleSheet("color: red;")

        # Catch exceptions
        except Exception as e:
            self.ui.mainPages.setCurrentWidget(self.ui.networkErrorPage) 
            AppFunctions.showPopUpError(self, 
                "You need internet connection to login. Please check your connection then try again.",
                e) 
            print(e)
```

- During the login or signup process, if an error occurs a popup message should be display. Add the following function below the login function to display popup messages:

```python
    #######################################################################
    # SHOW POPUP MESSAGE
    #######################################################################
    def showPopUpError(self, message, more):
        msg = QMessageBox()
        msg.setIcon(QMessageBox.Critical)
        msg.setText(message)
        msg.setInformativeText(str(more))
        msg.setWindowTitle("Error")
        msg.exec_()
```
- If a user successfully logs in or reisters, an online server will respond a new ``App ID`` and ``App Key``. The app id and key will be saved in app settings to create an ``App Session``. Add the following function below the "showPopUpError" to create a new app id and key:

```python
    #######################################################################
    # SAVE APP DETAILS
    #######################################################################
    def createNewAppKey(self, id, key):
        settings = QSettings()
        settings.setValue("APPID", id)
        settings.setValue("APPKEY", key)
```

- Now let us create a function to valiate and submit the register form. Add these functions just below the "createNewAppKey".
- Validate register form:

```python
    #######################################################################
    # VALIDATE REGISTRATION FORM
    #######################################################################
    def register(self):
        if len(self.ui.signup_username.text()) > 3:
            if len(self.ui.signup_password.text()) < 10:
                self.ui.registerResponse.setText("Please enter a valid password. Minimum password length is 10")
                self.ui.registerResponse.setStyleSheet("color: red;")
            else:
                if self.ui.signup_password.text() == self.ui.signup_conf_password.text():
                    self.ui.registerResponse.setText("Please wait...")
                    self.ui.registerResponse.setStyleSheet("color: '';")

                    # Submit register data
                    AppFunctions.registeruser(self)
                else:
                    self.ui.registerResponse.setText("Passwords not matching, please check your password.")
                    self.ui.registerResponse.setStyleSheet("color: red;")
        
        else:
            self.ui.registerResponse.setText("Please enter a valid username")
            self.ui.registerResponse.setStyleSheet("color: red;")
```

- Submit the register form:

```python
    #######################################################################
    # SUBMIT REGISTRATION FORM
    #######################################################################
    def registeruser(self):
        username = self.ui.signup_username.text()
        password = self.ui.signup_password.text()
        c_password = self.ui.signup_conf_password.text()
        # CATCH NETWORK ERROR USING TRY CATCH METHOD
        try:
            # url = "http://localhost/appsettings/"
            url = "http://project.spinntv.com/python/qtsettings/"
            data = {"register": True, "username":username,"password":password,"confirm_password":c_password}
            responseData = json.loads(requests.post(url, data=data).content.decode('utf-8'))
            print(responseData)
            self.ui.registerResponse.setText(responseData['response_message'])
            # If registered continue to final page
            if responseData['registered']:
                AppFunctions.createNewAppKey(self, responseData['app_id'], responseData['app_key'])
                AppFunctions.checkAppKey(self)

            else:
                self.ui.registerResponse.setStyleSheet("color: red;")

        except Exception as e:
            self.ui.mainPages.setCurrentWidget(self.ui.networkErrorPage) 
            AppFunctions.showPopUpError(self, 
                "You need internet connection to register. Please check your connection then try again.",
                e) 
            print(e)
```

- The users should also be able to ``logout`` or ``destroy app session``. The following function logs out users by removing the app key from settings:

```python
    #######################################################################
    # LOGOUT
    #######################################################################
    def logout(self):
        settings = QSettings()
        # settings.setValue("APPID", id)
        settings.setValue("APPKEY", "")
        self.ui.loginResponse.setText("Account logged out. Please login.")
        self.ui.mainPages.setCurrentWidget(self.ui.loginPage)
        self.ui.userAccountPages.setCurrentWidget(self.ui.loginAccount)
```

> Please note that we did not remove the ``app id`` above. The app id will be used to keep track of the actual number of applications in use, so it should be generated only once for each app.

- If the ``app key`` is still valid or ``not expired`` the app should automatically log in when the user opens it again. 
- The following funtion returns the current app id and key. Add it just below the "logout" function.

```python
    #######################################################################
    # GET APP KEY AND ID
    #######################################################################
    def getAppIdKey(self):
        settings = QSettings()
        id = settings.value("APPID")
        key = settings.value("APPKEY")

        return id, key
```

- Now this function will be used to validate the stored app id and key, an also automatically login users if the app key and id are valid. Add this function below "getAppIdKey" function:

```python
    #######################################################################
    # VALIDATE THE SAVED APP KEY AND ID
    #######################################################################
    def checkAppKey(self):
        # CATCH NETWORK ERROR USING TRY CATCH METHOD
        try:
            # url = "http://localhost/appsettings/"
            url = "http://project.spinntv.com/python/qtsettings/"
            id, key = AppFunctions.getAppIdKey(self)
            data = {"checkapp": True, "app_id": id, "app_key": key}
            responseData = json.loads(requests.post(url, data=data).content.decode('utf-8'))
            print(responseData)
            self.ui.loginResponse.setText(responseData['response_message'])
            # If logged in continue to final page
            if responseData['valid_app']:
                self.ui.mainPages.setCurrentWidget(self.ui.homePage)
                self.ui.appDetails.setText("""
                    <html><head/><body>
                    <p align="center">
                    <span style=" font-weight:600;">Username:</span> % s</p>
                    <p align="center"><span style=" font-weight:600;">App ID:</span> % s</p>
                    <p align="center"><span style=" font-weight:600;">APP Key:</span> % s</p>
                    <p align="center"><span style=" font-weight:600;">Expiry Date:</span> % s</p>
                    </body></html>
                    """ %(responseData['username'], responseData['app_id'], 
                        responseData['app_key'], responseData['expiry_date'])
                    )

                self.ui.userAccountPages.setCurrentWidget(self.ui.loggedAccountDetails)
                self.ui.username.setText(responseData['username'])
                self.ui.app_id.setText(responseData['app_id'])
                self.ui.app_key.setText(responseData['app_key'])
                self.ui.key_date.setText(responseData['expiry_date'])

            else:
                self.ui.mainPages.setCurrentWidget(self.ui.loginPage)

        except Exception as e:
            self.ui.mainPages.setCurrentWidget(self.ui.networkErrorPage)   
            AppFunctions.showPopUpError(self, 
                "You need internet connection to login. Please check your connection then try again.",
                e)        
            print(e)
```
- Inside the ``main.py`` file, inside the ``MainWindow class``, call the "checkAppKey" from functions. This will run the "checkAppKey" function on app startup:

```python
        # Check app key on app startup
        AppFunctions.checkAppKey(self)
```

- We also need to bind the button events to login, register and logout app users by adding the following statements in "main.py" file:

```python
        # Submit login details/form
        self.ui.submitLogin.clicked.connect(lambda: AppFunctions.login(self))
        # Submit register details/form
        self.ui.signup_btn.clicked.connect(lambda: AppFunctions.register(self))
        # Logout user
        self.ui.logoutBtn.clicked.connect(lambda: AppFunctions.logout(self))
        self.ui.logoutUser.clicked.connect(lambda: AppFunctions.logout(self))
        # Try again to login or register on network error
        self.ui.tryAgain.clicked.connect(lambda: AppFunctions.checkAppKey(self))
```

> For testing purposes you can skip the next step because the database and website have already been created for Url "http://project.spinntv.com/python/qtsettings/". Just go ahead and run your app, everything should work fine.
> For TESTING ONLY. To create your own database and website, continue reading.

- The next step is to now create the user database and validate the submitted details, then respond with an app id and key. We will use ``PHP`` and ``SQL``.

## Online user aunthenthication using SQL and PHP
As you might have noticed the ``url requests`` were being sent to ``"http://project.spinntv.com/python/qtsettings/"``. So you need to have a ``PHP website host`` and also have access to ``php Myadmin`` for creating a database.

> You can host a website on your local machine using applications such as ``Xampp``. Remember to ``update the url's`` in Functions to match your website host.

### Creating the database
- Open your php myadmin page ("http://localhost/phpmyadmin/" for local host).
- Create your database. Note the ``database name``, I named mine ``"spinntvc_spinntv"``.
- Click on ``SQL`` tab, copy the SQL code below, paste it inside the SQL queries input then click "GO".

```sql
-- phpMyAdmin SQL Dump
-- version 4.9.7
-- https://www.phpmyadmin.net/
--
-- Host: localhost:3306
-- Generation Time: Jul 14, 2022 at 09:21 PM
-- Server version: 5.7.36
-- PHP Version: 7.3.30

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
SET AUTOCOMMIT = 0;
START TRANSACTION;
SET time_zone = "+00:00";


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;

--
-- Database: `spinntvc_spinntv`
--

-- --------------------------------------------------------

--
-- Table structure for table `applications`
--

CREATE TABLE `applications` (
  `application_id` int(11) NOT NULL,
  `user_id` int(11) NOT NULL,
  `application_key` text NOT NULL,
  `key_expiration_date` datetime NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- --------------------------------------------------------

--
-- Table structure for table `user_information`
--

CREATE TABLE `user_information` (
  `user_id` int(11) NOT NULL,
  `user_name` varchar(200) NOT NULL,
  `user_password` varchar(200) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=latin1;

--
-- Dumping data for table `user_information`
--

INSERT INTO `user_information` (`user_id`, `user_name`, `user_password`) VALUES
(1, ':user_name', ':user_password'),
(2, 'Admin', '1234'),
(3, 'Test', 'Test');

--
-- Indexes for dumped tables
--

--
-- Indexes for table `applications`
--
ALTER TABLE `applications`
  ADD PRIMARY KEY (`application_id`);

--
-- Indexes for table `user_information`
--
ALTER TABLE `user_information`
  ADD PRIMARY KEY (`user_id`);

--
-- AUTO_INCREMENT for dumped tables
--

--
-- AUTO_INCREMENT for table `applications`
--
ALTER TABLE `applications`
  MODIFY `application_id` int(11) NOT NULL AUTO_INCREMENT;

--
-- AUTO_INCREMENT for table `user_information`
--
ALTER TABLE `user_information`
  MODIFY `user_id` int(11) NOT NULL AUTO_INCREMENT, AUTO_INCREMENT=4;
COMMIT;

/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;

```

Now you have created your database. Next we are going to create the PHP files.

### Creating the website(PHP files)
PHP will be responsibe for receiving our input, querying the database, then sending the feedback back to the app.

- Locate your ``www`` or ``htdoc`` folder. Create a new folder, I named mine "qtsettings".
- Inside your new folder, create a new php file. Name this file ``database_connector.php``. This file will be responsible for connecting to the database.

> For a successful connection, you need to know your databese ``host, username, password`` and the ``database name``.

- Copy and paste the code below inside the "database_connector.php". 

```php
<?php
	// Connect to database
	// database host
	define('DB_HOST','localhost');
	define('DB_USER','root');
	define('DB_PASS','');
	define('DB_NAME','spinntvc_spinntv');
	try
	{
	$dbh = new PDO("mysql:host=".DB_HOST.";dbname=".DB_NAME,DB_USER, DB_PASS,array(PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES 'utf8'"));
	}
	catch (PDOException $e)
	{
		exit("Error: " . $e->getMessage());
	}
?> 

```

> Update the DB_HOST, DB_USER, DB_PASS, DB_NAME above if necessary.

- Now the next step is to create the our main php file, ``index.php`` inside your php folder. 
- Our main php file will be giving a data response in ``JSON`` format, so lets start by adding the ``header function`` inside the index.php.

```php
<?php 
	header('Content-type: application/json');
?>
```

- Then import the ``database connector`` file.
```php
<?php 
	header('Content-type: application/json');
	// Include database connector
	include 'database_connector.php';
?>
```
- Now create a function to login users:

```php
    // login user
	if (isset($_POST['login'])) {
		// default login bool
		$data['logged_in'] = False;

		$data['app_key'] = "";
		$data['app_id'] = "";

		// Check username
		if (!isset($_POST['username']) or empty($_POST['username'])) {
			$data['response_message'] = "The username is required";
		// check password
		}elseif (!isset($_POST['password']) or empty($_POST['password'])) {
			$data['response_message'] = "The password is required";
		}else{
			// Check if username and password is correct
			$sql = "SELECT * FROM `user_information` WHERE `user_name` = '".$_POST['username']."' AND `user_password` = '".$_POST['password']."'";
			$query = $dbh->prepare($sql); $query->execute(); 
			$result = $query;
			if ($row = $result->fetch( PDO::FETCH_ASSOC )){
				$data['response_message'] = "Successfully logged in";
				$data['logged_in'] = True;

				if (isset($_POST['app_id']) && !empty($_POST['app_id']) && isset($_POST['app_key'])) {
					// Check if the app key and ID is valid
					if (checkAppKey($_POST['app_id'], $_POST['app_key']) || checkAppId($_POST['app_id'], $row['user_id'])) {
						// renew app key
						$id = $_POST['app_id'];
						if (renewAppKey($id)) {
							$data['app_key'] = getAppKey($id);
						}else{
							$data['app_key'] = "";
						}

						$data['app_id'] = $_POST['app_id'];
					}else{
						$data['app_key'] = createNewApp($_POST['username']);
						$data['app_id'] = getAppId($data['app_key']);
					}
				}else{
					$data['app_key'] = createNewApp($_POST['username']);
					$data['app_id'] = getAppId($data['app_key']);
				}

			}else{
				$data['response_message'] = "Invalid username or password";
			}
		}
	}
```

- Next, create a function to register users:

```php
    // Register user
	if (isset($_POST['register'])) {
		$data['registered'] = False;

		$data['app_key'] = "";
		$data['app_id'] = "";

		if (!isset($_POST['username']) or empty($_POST['username'])) {
			$data['response_message'] = "The username is required";
		}elseif (!isset($_POST['password']) or empty($_POST['password'])) {
			$data['response_message'] = "The password is required";
		}elseif (!isset($_POST['confirm_password']) or empty($_POST['confirm_password'])) {
			$data['response_message'] = "Please confirm your password";
		}elseif ($_POST['password'] !== $_POST['confirm_password']) {
			$data['response_message'] = "Passwords not matching";
		}else{
			$sql = "SELECT * FROM `user_information` WHERE `user_name` = '".$_POST['username']."'";
			$query = $dbh->prepare($sql); $query->execute(); 
			$result = $query;
			if ($row = $result->fetch( PDO::FETCH_ASSOC )){
				$data['response_message'] = "The user with that username already exists, please select a different username";
			}else{
				$sql = "INSERT INTO `user_information`(`user_id`, `user_name`, `user_password`) VALUES (NULL, :user_name, :user_password)";

		        $query = $dbh->prepare($sql);

		        $query->bindParam('user_name', $_POST['username'], PDO::PARAM_STR );
		        $query->bindParam('user_password', $_POST['password'], PDO::PARAM_STR );

		        $query->execute();

				$data['response_message'] = "Your account was succesfully created";

				$data['registered'] = True;

				$data['app_key'] = createNewApp($_POST['username']);
				$data['app_id'] = getAppId($data['app_key']);
			}
		}
	}
```

- After a user has been successfully registered or logged in, the website should send back the **App ID** and **App Key**. The following function creates the app id and key from the username:

```php
    // Create new app ID/KEY
	function createNewApp($username)
	{
		global $dbh;
		// get user id
        $sql = "SELECT * FROM `user_information` WHERE `user_name` = '".$username."'";
		$query = $dbh->prepare($sql); $query->execute(); 
		$result = $query;
		if ($row = $result->fetch( PDO::FETCH_ASSOC )){
			$id = $row['user_id'];
			$expiry_date = date('Y-m-d H:i:s', strtotime('+1 day', time()));

			// Generate random app key
			$application_key = random_str(12);
			// Check if the key exists
			while (view_app_key($application_key) == "true") {
	    		$application_key = random_str(12);
	    	}
	    	// insert new app key and id
	    	$sql = "INSERT INTO `applications`(`application_id`, `user_id`, `application_key`, `key_expiration_date`) VALUES (NULL, :user_id, :application_key, :key_expiration_date)";

	        $query = $dbh->prepare($sql);

	        $query->bindParam('user_id', $id, PDO::PARAM_STR );
	        $query->bindParam('application_key', $application_key, PDO::PARAM_STR );
	        $query->bindParam('key_expiration_date', $expiry_date, PDO::PARAM_STR );

	        $query->execute();

	        // return new app key
	        return $application_key;
	    }else{
	    	return "";
	    }
	}
```
> The above function only returns the app key "``return $application_key;``". So we need to create another function to fetch the app ID.

- Create a fuction that returns the app id from the app key:

```php
    // get app ID from key
	function getAppId($key)
	{
		global $dbh;

		$sql = "SELECT * FROM `applications` WHERE `application_key` = '".$key."'";
		$query = $dbh->prepare($sql); $query->execute(); 
		$result = $query;
		if ($row = $result->fetch( PDO::FETCH_ASSOC )){
			return $row['application_id'];
		}else{
			return "";
		}
	}
```

- We also need to create a function that returns the app key from the ID:

```php
    // get app key from ID
	function getAppKey($id)
	{
		global $dbh;

		$sql = "SELECT * FROM `applications` WHERE `application_id` = '".$id."'";
		$query = $dbh->prepare($sql); $query->execute(); 
		$result = $query;
		if ($row = $result->fetch( PDO::FETCH_ASSOC )){
			return $row['application_key'];
		}else{
			return "";
		}
	}
```

- For ``auto-login`` our python app will only submit the App Key and App ID for validation, so we need to add a function that will take the app key and id, then checks for validity.
- Add the following function inside "index.php" file.

```php
    // check app key and id
	if (isset($_POST['checkapp'])) {
		$data['valid_app'] = False;
		if (!isset($_POST['app_key']) or empty($_POST['app_key'])) {
			$data['response_message'] = "Invalid app key";
		}elseif (!isset($_POST['app_id']) or empty($_POST['app_id'])) {
			$data['response_message'] = "Invalid app id";
		}else{
			if (checkAppKey($_POST['app_id'], $_POST['app_key'])) {
				if (checkAppKeyExpiration($_POST['app_key'])) {
					$data['response_message'] = "App key expired! Please login";
				}else{
					$data['response_message'] = "Valid app key and id";
					$data['valid_app'] = True;
					$userDetails = getAppUser($_POST['app_id']);
					if(!empty($userDetails) && isset($userDetails['user_name'])){
						$data['username'] = $userDetails['user_name'];
					}else{
						$data['username'] = "";
					}

					$appDetails = getAppDetails($_POST['app_id']);
					if(!empty($appDetails) && isset($appDetails['key_expiration_date'])){
						$data['expiry_date'] = $appDetails['key_expiration_date'];
					}else{
						$data['expiry_date'] = "unknown";
					}
				}
			}else{
				$data['response_message'] = "Invalid app id or key";
			}
		}

		$data['app_id'] = $_POST['app_id'];
		$data['app_key'] = $_POST['app_key'];
	}
```

- Now we can add a function that takes the app id and key then checks if they are valid:

```php
    // check app key from id
	function checkAppKey($id, $key)
	{
		global $dbh;

		$sql = "SELECT * FROM `applications` WHERE `application_id` = '".$id."'";
		$query = $dbh->prepare($sql); $query->execute(); 
		$result = $query;
		if ($row = $result->fetch( PDO::FETCH_ASSOC )){
			if ($row['application_key'] == $key) {
				return true;
			}else{
				return false;
			}
		}else{
			return false;
		}
	}

	// check if app id belongs to user id
	function checkAppId($app_id, $user_id)
	{
		global $dbh;

		$sql = "SELECT * FROM `applications` WHERE `application_id` = '".$app_id."' AND `user_id` = '".$user_id."'";
		$query = $dbh->prepare($sql); $query->execute(); 
		$result = $query;
		if ($row = $result->fetch( PDO::FETCH_ASSOC )){
			return true;
		}else{
			return false;
		}
	}
```

- We also need to check if the app key has expired:

```php
    // check app key expiration
	function checkAppKeyExpiration($key)
	{
		global $dbh;

		$sql = "SELECT * FROM `applications` WHERE `application_key` = '".$key."'";
		$query = $dbh->prepare($sql); $query->execute(); 
		$result = $query;
		if ($row = $result->fetch( PDO::FETCH_ASSOC )){
			$current_date = date("Y-m-d H:i:s");
			$expiration_date = $row['key_expiration_date'];

			if (strtotime($current_date) > strtotime($expiration_date)) {
				return true;
			}else{
				return false;
			}
		}else{
			return true;
		}
	}
```

> Note that we set our app key to expire after ``1 day/ 24 hours``, check ``createNewApp`` fuction: ``$expiry_date = date('Y-m-d H:i:s', strtotime('+1 day', time()));``. Adjust this statement to match your desired expiration date.

- After the app key has expired, we need the renew the key. The following function create a new app key for the existing the app ID.

```php
	// renew app key
	function renewAppKey($id)
	{
		global $dbh;

		$sql = "SELECT * FROM `applications` WHERE `application_id` = '".$id."'";
		$query = $dbh->prepare($sql); $query->execute(); 
		$result = $query;
		if ($row = $result->fetch( PDO::FETCH_ASSOC )){

			$expiry_date = date('Y-m-d H:i:s', strtotime('+1 day', time()));

			// Generate random app key
			$application_key = random_str(12);
			// Check if the key exists
			while (view_app_key($application_key) == "true") {
	    		$application_key = random_str(12);
	    	}

			$sql = "UPDATE `applications` SET `application_key`= :application_key,`key_expiration_date`= :key_expiration_date WHERE `application_id`= :application_id";

	        $query = $dbh->prepare($sql);

	        $query->bindParam('application_key', $application_key, PDO::PARAM_STR );
	        $query->bindParam('key_expiration_date', $expiry_date, PDO::PARAM_STR );
	        $query->bindParam('application_id', $id, PDO::PARAM_STR );

	        $query->execute();

	        return true;
		}else{
			return false;
		}
	}
```

- Our app key consists of randomly generated string(of length 12). This function is responsible for generating the app key:

```php
    // Generate random strings
	function random_str(
        int $length = 64,
        string $keyspace = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'
    ): string {
        if ($length < 1) {
            throw new \RangeException("Length must be a positive integer");
        }
        $pieces = [];
        $max = mb_strlen($keyspace, '8bit') - 1;
        for ($i = 0; $i < $length; ++$i) {
            $pieces []= $keyspace[random_int(0, $max)];
        }
        return implode('', $pieces);
    }
```

- When a new key is generated, we need to check if the key exists before asigning it to the app:

```php
    // view if app key already exists
    function view_app_key($link)
    {
    	global $dbh;
    	$sql = "SELECT * FROM `applications` WHERE `application_key`='".$link."'";
    	$query = $dbh->prepare($sql); 
    	$query->execute(); 
		$result = $query;
		if ($row = $result->fetch( PDO::FETCH_ASSOC )){
			return "true";
    	}else{
    		return "false";
    	}

    }
```

- Finally we can add two functions that will return the app and user details:

```php
	// get app user from ID
	function getAppUser($id)
	{
		global $dbh;
		

		$sql = "SELECT * FROM `applications` WHERE `application_id` = '".$id."'";
		$query = $dbh->prepare($sql); $query->execute(); 
		$result = $query;
		if ($row = $result->fetch( PDO::FETCH_ASSOC )){
			$userId = $row['user_id'];
			$sql = "SELECT * FROM `user_information` WHERE `user_id` = '".$userId."'";
			$query = $dbh->prepare($sql); $query->execute(); 
			$result = $query;
			if ($row = $result->fetch( PDO::FETCH_ASSOC )){
				return $row;
			}
			$row = [];
			return $row;
		}
	}

	// get app details
	function getAppDetails($id)
	{
		global $dbh;

		$sql = "SELECT * FROM `applications` WHERE `application_id` = '".$id."'";
		$query = $dbh->prepare($sql); $query->execute(); 
		$result = $query;
		if ($row = $result->fetch( PDO::FETCH_ASSOC )){
			return $row;
		}else{
			$row = [];
			return $row;
		}
	}
```

That is all, now you have created a desktop app with user settings and session management. 

**Video tutorial will be available soon** [here](https://www.youtube.com/c/SpinnTV)

[Support my work](https://www.patreon.com/spinntv)

## License
MIT

